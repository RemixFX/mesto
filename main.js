(()=>{"use strict";class e{constructor(e,t,s,i,{handleAddLike:r,handleDeleteLike:n,handleRemoveClick:o}){this._name=e.name,this._link=e.link,this._alt=e.alt,this._likes=e.likes,this._owner=e.owner._id,this._userId=s,this._cardId=e._id,this._cardSelector=t,this._handleCardClick=i,this._handleAddLike=r,this._handleDeleteLike=n,this._handleRemoveClick=o,this._element=this._getTemplate(),this._elementDeleteButton=this._element.querySelector(".element__delete-button"),this.likeButton=this._element.querySelector(".element__like-button"),this.likeValue=this._element.querySelector(".element__like-value")}_getTemplate(){return document.querySelector(this._cardSelector).content.querySelector(".element").cloneNode(!0)}generateCard(){const e=this._element.querySelector(".element__image");return this._element.querySelector(".element__name").textContent=this._name,e.src=this._link,e.alt=this._alt,this.likeValue.textContent=this._likes.length,this._checkOwnerCard(),this._checkOwnerLike(),this._setEventListeners(),this._element}setLikeValue(e){this.likeValue.textContent=e.likes.length}checkIsLiked(){this.isLiked=!this.isLiked}addLike(){this.likeButton.classList.add("element__like-button_type_active")}deleteLike(){this.likeButton.classList.remove("element__like-button_type_active")}_callBackId(){this.likeButton.classList.contains("element__like-button_type_active")?this._handleDeleteLike(this._cardId,this):this._handleAddLike(this._cardId,this)}_removeCard(){this._element.remove()}_checkOwnerLike(){this._likes.some((e=>e._id===this._userId))&&this.likeButton.classList.add("element__like-button_type_active")}_checkOwnerCard(){this._owner!==this._userId&&this._elementDeleteButton.classList.add("element__delete-button_disabled")}_setEventListeners(){this.likeButton.addEventListener("click",(()=>this._callBackId(this))),this._elementDeleteButton.addEventListener("click",(()=>{this._handleRemoveClick({cardNode:this._element,cardId:this._cardId})})),this._element.addEventListener("animationend",(()=>this._removeCard())),this._element.querySelector(".element__image").addEventListener("click",(()=>this._handleCardClick(this._name,this._link)))}}class t{constructor(e,t){this._formElement=t,this._inputSelector=e.inputSelector,this._submitButtonSelector=e.submitButtonSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._inputList=Array.from(this._formElement.querySelectorAll(this._inputSelector)),this._buttonElement=this._formElement.querySelector(this._submitButtonSelector)}_showInputError(e){this._getErrorElement(e),e.classList.add(this._inputErrorClass),this._errorElement.textContent=e.validationMessage,this._errorElement.classList.add(this._errorClass)}_hideInputError(e){this._getErrorElement(e),e.classList.remove(this._inputErrorClass),this._errorElement.classList.remove(this._errorClass)}_getErrorElement(e){this._errorElement=this._formElement.querySelector(`#${e.id}-error`)}_checkInputValidity(e){e.validity.valid?this._hideInputError(e,this._inputErrorClass,this._errorClass):this._showInputError(e,this._inputErrorClass,this._errorClass)}_checkFormValidity(){return this._inputList.some((e=>!e.validity.valid))}_toggleButtonState(){this._checkFormValidity(this._inputList)?(this._buttonElement.classList.add(this._inactiveButtonClass),this._buttonElement.setAttribute("disabled","good")):(this._buttonElement.classList.remove(this._inactiveButtonClass),this._buttonElement.removeAttribute("disabled"))}resetValidation(){this._toggleButtonState(),this._inputList.forEach((e=>{this._hideInputError(e)}))}_setEventListeners(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))})),this._toggleButtonState()}enableValidation(){this._setEventListeners()}}class s{constructor(e){this._popup=document.querySelector(e)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose=e=>{"Escape"===e.key&&this.close()};setEventListeners(){this._popup.addEventListener("click",(e=>{e.target.classList.contains("popup_opened")&&this.close(),e.target.classList.contains("popup__close-button")&&this.close()}))}}class i extends s{constructor({handleFormSubmit:e,popupSelector:t}){super(t),this._handleFormSubmit=e,this._form=this._popup.querySelector(".form"),this._inputList=this._popup.querySelectorAll(".form__input")}_getInputValues(){return this._formValues={},this._inputList.forEach((e=>{this._formValues[e.name]=e.value})),this._formValues}close(){super.close(),this._form.reset()}renderLoading(e,t){const s=this._popup.querySelector(".popup__submit-button");e?s.textContent="Сохранение...":e||(s.textContent=`${t}`)}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleFormSubmit(this._getInputValues())}))}}const r={inputSelector:".form__input",submitButtonSelector:".popup__submit-button",inactiveButtonClass:"popup__submit-button_disabled",inputErrorClass:"form__input_type_error",errorClass:"form__error_visible"},n=document.querySelector(".profile__edit-button"),o=document.querySelector(".form__input_type_name"),a=document.querySelector(".form__input_type_job"),l=document.querySelector(".profile__add-button"),h=document.querySelector(".form-add-card"),c=document.querySelector(".form-profile"),d=document.querySelector(".form-edit-avatar"),_=document.querySelector(".popup-confirmation__heading"),u=document.querySelector(".profile__avatar-button"),p=new class{constructor(e){this._url=e.url,this._headers=e.headers}_checkResponse(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}getPageInfo(){return Promise.all([this.getUserData(),this.getInitialCards()])}getUserData(){return fetch(`${this._url}users/me`,{headers:this._headers}).then(this._checkResponse)}getInitialCards(){return fetch(`${this._url}cards`,{headers:this._headers}).then(this._checkResponse)}patchUserData(e){return fetch(`${this._url}users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.name,about:e.about})}).then(this._checkResponse)}uploadNewCard(e){return fetch(`${this._url}cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e.name,link:e.link})}).then(this._checkResponse)}deleteCard(e){return fetch(`${this._url}cards/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}sendLike(e){return fetch(`${this._url}cards/likes/${e}`,{method:"PUT",headers:this._headers}).then(this._checkResponse)}removeLike(e){return fetch(`${this._url}cards/likes/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}patchUserAvatar(e){return fetch(`${this._url}users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.avatar})}).then(this._checkResponse)}}({url:"https://mesto.nomoreparties.co/v1/cohort-29/",headers:{authorization:"0fe39d88-814c-4d9c-a2d1-36a2026603cf","Content-type":"application/json"}}),m=new class{constructor(e,t,s){this._profileName=document.querySelector(e),this._profileJob=document.querySelector(t),this._profileAvatar=document.querySelector(s)}getUserInfo(){return{name:this._profileName.textContent,about:this._profileJob.textContent}}setUserInfo(e){this._profileName.textContent=e.name,this._profileJob.textContent=e.about,this._profileAvatar.src=e.avatar}}(".profile__name",".profile__job",".profile__avatar"),k=new class extends s{constructor(e){super(e),this._imagePopupName=this._popup.querySelector(".popup-card__image-name"),this._imagePopupLink=this._popup.querySelector(".popup-card__image")}open({name:e,link:t}){super.open(),this._imagePopupName.textContent=e,this._imagePopupLink.src=t}}(".popup-card");k.setEventListeners();const L=new i({popupSelector:".popup_type_edit-profile",handleFormSubmit:e=>{L.renderLoading(!0),p.patchUserData(e).then((e=>{m.setUserInfo(e),L.close()})).catch((e=>{console.log(e)})).finally((()=>L.renderLoading(!1,"Сохранить")))}});L.setEventListeners(),n.addEventListener("click",(function(){const e=m.getUserInfo();o.value=e.name,a.value=e.about,b.resetValidation(),L.open()}));const f=new i({popupSelector:".popup-avatar-edit",handleFormSubmit:e=>{f.renderLoading(!0),p.patchUserAvatar(e).then((e=>{m.setUserInfo(e),f.close()})).catch((e=>{console.log(e)})).finally((()=>f.renderLoading(!1,"Сохранить")))}});f.setEventListeners(),u.addEventListener("click",(()=>{f.open(),I.resetValidation()}));const v=(e,t)=>k.open({name:e,link:t}),E=new class extends s{constructor(e,{handleConfirmButton:t}){super(e),this._handleConfirmButton=t,this._form=this._popup.querySelector(".form")}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleConfirmButton(this.cardinfo)}))}}(".popup-confirmation",{handleConfirmButton:e=>{p.deleteCard(e.cardId).then((t=>{_.textContent=t.message,e.cardNode.classList.add("element-animated"),setTimeout((()=>E.close()),800)})).catch((e=>{console.log(e)}))}});E.setEventListeners();const C=new class{constructor({renderer:e},t){this._renderer=e,this._container=document.querySelector(t)}addItem(e){this._container.prepend(e)}renderItems(e){e.forEach((e=>{this._renderer(e)}))}}({renderer:t=>{C.addItem((t=>new e(t,"#elements-template",g,v,{handleAddLike:(e,t)=>{p.sendLike(e).then((e=>{t.setLikeValue(e),t.addLike(t)})).catch((e=>console.log(e)))},handleDeleteLike:(e,t)=>{p.removeLike(e).then((e=>{t.setLikeValue(e),t.deleteLike(t)})).catch((e=>console.log(e)))},handleRemoveClick:e=>{E.cardinfo=e,_.textContent="Вы уверены?",E.open()}}).generateCard())(t))}},".elements");let g;p.getPageInfo().then((([e,t])=>{m.setUserInfo(e),g=e._id,C.renderItems(t)})).catch((e=>{console.log(e)}));const y=new i({popupSelector:".popup_type_add-card",handleFormSubmit:e=>{y.renderLoading(!0),p.uploadNewCard(e).then((e=>{C.renderItems([e]),y.close()})).catch((e=>{console.log(e)})).finally((()=>y.renderLoading(!1,"Создать")))}});y.setEventListeners(),l.addEventListener("click",(()=>{y.open(),S.resetValidation()}));const S=new t(r,h);S.enableValidation();const b=new t(r,c);b.enableValidation();const I=new t(r,d);I.enableValidation()})();